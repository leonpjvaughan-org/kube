# OIDC enabled cluster

## Prerequisites

1. Ensure your Kubernetes cluster OIDC enabled. I have links below for RKE2 and Keycloak.
2. Ensure you have an iam provider that supports OIDC. I use Keycloak, but you can use any OIDC provider. Configure a client in your OIDC provider for your Kubernetes cluster. You will need the client ID, client secret, and issuer URL.

See [my ansible playbook](https://github.com/leonpjvaughan/homelabauto/tree/master/ansible-rke2-update-oidc-config). This shows how to enable OIDC in RKE2.

This [resource](https://hannaske.net/blog/oidc-authentication-in-rke2-kubernetes-with-keycloak/) shows an example with Keycloak.

## Map keycloak group to Kubernetes role

I map the Keycloak group `kubeAdmin` to the Kubernetes role `cluster-admin`. This allows users in the Keycloak group to have cluster admin privileges in Kubernetes.

```shell
kubectl apply -f oidc-roles/oidc-group-rolebind.yaml
```

create as many groups and roles as you need. 

## OIDC setup

Install kubelogin (oidc-login plugin). I am using krew to install it, but you can also install it manually.

[krew install](https://krew.sigs.k8s.io/docs/user-guide/setup/install/)

```shell
kubectl krew install oidc-login
```

## update kubeconfig
You will need to update your kubeconfig file to use the OIDC provider. You can do this manually or use a tool like `kubectl oidc-login`.

kubectl oidc-login setup will help you set up your kubeconfig file to use OIDC authentication. It will also confirrm you have set up the OIDC correctly.

```bash
kubectl oidc-login setup --oidc-issuer-url <OIDC_ISSUER_URL> --oidc-client-id <OIDC_CLIENT_ID> --oidc-client-secret <OIDC_CLIENT_SECRET>

... outputs token info ...

... outputs the command below ...

kubectl config set-credentials <anyusername> \
  --exec-api-version=client.authentication.k8s.io/v1 \
  --exec-interactive-mode=Never \
  --exec-command=kubectl \
  --exec-arg=oidc-login \
  --exec-arg=get-token \
  --exec-arg="--oidc-issuer-url=<OIDC_ISSUER_URL>" \
  --exec-arg="--oidc-client-id=<OIDC_CLIENT_ID>" \
  --exec-arg="--oidc-client-secret=<OIDC_CLIENT_SECRET>"
```

You then need to create a context in your kubeconfig file that uses the OIDC credentials. I also set the current context to the OIDC user context.

```yaml
# ~/.kube/config
apiVersion: v1
clusters:
...
contexts:
- context: # this is the default context - can be removed now (but copy the details just in case)
    cluster: default
    user: default
  name: default
# create a context for your OIDC user
- context:
    cluster: default
    user: oidc
  name: oidc-context
current-context: oidc-context  # I set this to the OIDC user context
kind: Config
preferences: {}
users:
- name: default
  user:
    client-certificate-data: ... # your client certificate data
    client-key-data: ... # your client key data

## this was automatically generated by kubectl oidc-login setup
- name: oidc
  user:
    exec:
      apiVersion: client.authentication.k8s.io/v1
      args:
      - oidc-login
      - get-token
      - --oidc-issuer-url=<OIDC_ISSUER_URL>
      - --oidc-client-id=<OIDC_CLIENT_ID>
      - --oidc-client-secret=<OIDC_CLIENT_SECRET>
      command: kubectl
      env: null
      interactiveMode: Never
      provideClusterInfo: false
```

